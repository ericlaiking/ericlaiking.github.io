<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>éŸ³é »ç”¢ç”Ÿå™¨ï¼ˆiOS å®Œæ•´ä¿®æ­£ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      line-height: 1.6;
    }
    #enableAudio {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
    }
    #mainUI { display: none; }
    #muteWarning {
      color: red;
      font-weight: bold;
      display: none;
    }
  </style>
</head>
<body>
  <h2>éŸ³é »ç”¢ç”Ÿå™¨ï¼ˆiOS å®Œæ•´ä¿®æ­£ç‰ˆï¼‰</h2>

  <button id="enableAudio">ğŸ”ˆ é»æ“Šå•Ÿç”¨éŸ³è¨Š</button>
  <p id="muteWarning">ğŸ”‡ åµæ¸¬åˆ°è£ç½®å¯èƒ½è™•æ–¼éœéŸ³æ¨¡å¼ï¼Œè«‹è§£é™¤ iPhone éœéŸ³é–‹é—œæˆ–èª¿é«˜éŸ³é‡ã€‚</p>

  <div id="mainUI">
    <label><input type="checkbox" id="sweep" onchange="toggleSweep()"> å•Ÿç”¨æƒé »</label>
    <div id="sweep-controls" style="display:none;">
      <label>èµ·å§‹é »ç‡ (Hz): <input type="number" id="startFreq" value="200"></label>
      <label>çµæŸé »ç‡ (Hz): <input type="number" id="endFreq" value="2000"></label>
    </div>

    <label id="freqLabel">é »ç‡ (Hz): <input type="number" id="freq" value="1000"></label>
    <label>æŒçºŒæ™‚é–“ (ç§’): <input type="number" id="duration" value="2" step="0.1"></label>
    <label>éŸ³é‡ (0 ~ 1): <input type="number" id="volume" value="1" step="0.01" min="0" max="1"></label>

    <label>æ³¢å‹:
      <select id="waveform">
        <option value="sine">æ­£å¼¦æ³¢ (sine)</option>
        <option value="square">æ–¹æ³¢ (square)</option>
        <option value="triangle">ä¸‰è§’æ³¢ (triangle)</option>
        <option value="sawtooth">é‹¸é½’æ³¢ (sawtooth)</option>
      </select>
    </label>

    <label><input type="checkbox" id="sustain" onchange="toggleDuration()"> æŒçºŒæ’­æ”¾</label>

    <button id="playBtn">æ’­æ”¾</button>
    <button id="stopBtn">åœæ­¢</button>
  </div>

  <script>
    let audioCtx, oscillator, gainNode;

    function toggleDuration() {
      const sustain = document.getElementById('sustain').checked;
      document.getElementById('duration').disabled = sustain;
    }

    function toggleSweep() {
      const sweepEnabled = document.getElementById('sweep').checked;
      document.getElementById('sweep-controls').style.display = sweepEnabled ? 'block' : 'none';
      document.getElementById('freq').disabled = sweepEnabled;
      document.getElementById('freqLabel').style.color = sweepEnabled ? '#aaa' : '';
    }

    async function ensureAudioContext() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') await audioCtx.resume();
    }

    async function startOscillator() {
      await ensureAudioContext();

      const volume = parseFloat(document.getElementById('volume').value);
      const waveform = document.getElementById('waveform').value;
      const sustain = document.getElementById('sustain').checked;
      const duration = sustain ? null : parseFloat(document.getElementById('duration').value);
      const sweep = document.getElementById('sweep').checked;

      stopOscillator();

      oscillator = audioCtx.createOscillator();
      gainNode = audioCtx.createGain();

      oscillator.type = waveform;
      gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      if (sweep) {
        const startFreq = parseFloat(document.getElementById('startFreq').value);
        const endFreq = parseFloat(document.getElementById('endFreq').value);
        oscillator.frequency.setValueAtTime(startFreq, audioCtx.currentTime);
        if (!sustain && duration) {
          oscillator.frequency.linearRampToValueAtTime(endFreq, audioCtx.currentTime + duration);
        } else {
          oscillator.frequency.linearRampToValueAtTime(endFreq, audioCtx.currentTime + 5);
        }
      } else {
        const freq = parseFloat(document.getElementById('freq').value);
        oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
      }

      oscillator.start();
      if (!sustain && duration) oscillator.stop(audioCtx.currentTime + duration);
    }

    function stopOscillator() {
      if (oscillator) {
        try { oscillator.stop(); } catch {}
        oscillator.disconnect();
        oscillator = null;
      }
      if (gainNode) {
        gainNode.disconnect();
        gainNode = null;
      }
    }

    // -----------------------------
    // ğŸ” è‡ªå‹•åµæ¸¬ iPhone éœéŸ³æ¨¡å¼
    // -----------------------------
    async function detectMuteState() {
      return new Promise((resolve) => {
        const audio = document.createElement('audio');
        // ä½¿ç”¨ä¸€å€‹æ¥µçŸ­çš„ Data URI éŸ³è¨Šï¼ˆ44 bytes PCM silenceï¼‰
        audio.src = "data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCAAwEACAAACAAACAgAAAB9AAAABAAgAZGF0YQAAAAA=";
        audio.volume = 1.0;
        let played = false;

        const timer = setTimeout(() => resolve(true), 1500); // è¶…æ™‚ â†’ åˆ¤å®šéœéŸ³
        audio.onplaying = () => {
          played = true;
          clearTimeout(timer);
          resolve(false); // ééœéŸ³
        };
        audio.play().catch(() => {
          clearTimeout(timer);
          resolve(true); // æ’­æ”¾è¢«é˜»æ­¢ â†’ éœéŸ³
        });
      });
    }

    async function checkMute() {
      const isMuted = await detectMuteState();
      const warning = document.getElementById('muteWarning');
      if (isMuted) {
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }
    }

    // ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡è§¸æ§å•Ÿå‹•éŸ³è¨Š
    document.getElementById('enableAudio').addEventListener('click', async () => {
      await ensureAudioContext();
      document.getElementById('enableAudio').style.display = 'none';
      document.getElementById('mainUI').style.display = 'block';
      await checkMute(); // æª¢æŸ¥æ˜¯å¦éœéŸ³
    });

    document.getElementById('playBtn').addEventListener('click', async () => {
      await startOscillator();
      await checkMute(); // å†æª¢æŸ¥ä¸€æ¬¡
    });

    document.getElementById('stopBtn').addEventListener('click', stopOscillator);
  </script>
</body>
</html>
